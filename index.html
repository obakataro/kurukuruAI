<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</title>
  <style>
    body { margin: 0; font-family: sans-serif; overflow: hidden; }
    #toolbar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background: #f0f0f0; display: flex; align-items: center;
      padding: 0 10px; gap: 10px; z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    #board {
      position: absolute; top: 60px; left: 0; right: 0; bottom: 0;
      background: #fff; overflow: hidden;
    }
    .node {
      position: absolute; padding: 8px 12px;
      background: #ffe;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: grab; user-select: none;
    }
    .node.selected { border: 2px solid #66f; }
    #trash {
      position: fixed; right: 20px; bottom: 20px;
      width: 60px; height: 60px;
      font-size: 30px; text-align: center;
      line-height: 60px; border-radius: 50%;
      background: #fdd; border: 2px solid #f88;
    }
    #text-mode-btn { margin-left: auto; }
  </style>
</head>
<body>
  <div id=\"toolbar\">
    <button id=\"modeToggle\">AIãƒ¢ãƒ¼ãƒ‰</button>
    <input id=\"prompt\" placeholder=\"å˜èªã‚„æŒ‡ç¤ºã‚’å…¥åŠ›\" />
    <input id=\"count\" type=\"number\" value=\"3\" min=\"1\" style=\"width:60px;\" />
    <button id=\"genBtn\">ç”Ÿæˆ</button>
    <button id=\"text-mode-btn\">ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
  </div>

  <div id="board"></div>
  <div id="trash">ğŸ—‘ï¸</div>

  <script>
    const board = document.getElementById('board');
    const genBtn = document.getElementById('genBtn');
    let mode = 'ai'; // ai | word
    const promptInput = document.getElementById('prompt');
    const countInput = document.getElementById('count');
    let selectedNodes = new Set();
    let dragTarget = null;
    let offsetX = 0, offsetY = 0;
    let textMode = false;

    function createNode(text, x=200, y=200) {
      const el = document.createElement('div');
      el.className = 'node';
      el.textContent = text;
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      board.appendChild(el);

      el.addEventListener('mousedown', e => {
        if (!e.shiftKey) {
          selectedNodes.clear();
          document.querySelectorAll('.node').forEach(n=>n.classList.remove('selected'));
        }
        selectedNodes.add(el);
        el.classList.add('selected');

        dragTarget = el;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });

      return el;
    }

    document.addEventListener('mousemove', e => {
      if (dragTarget) {
        dragTarget.style.left = (e.pageX - offsetX) + 'px';
        dragTarget.style.top = (e.pageY - offsetY) + 'px';
      }
    });

    document.addEventListener('mouseup', e => {
      if (!dragTarget) return;
      const trash = document.getElementById('trash').getBoundingClientRect();
      const rect = dragTarget.getBoundingClientRect();
      if (
        rect.right > trash.left &&
        rect.left < trash.right &&
        rect.bottom > trash.top &&
        rect.top < trash.bottom
      ) {
        dragTarget.remove();
      }
      dragTarget = null;
    });

    // Gemini API call (GitHub Actions ãƒ—ãƒ­ã‚­ã‚·ç‰ˆ)
    async function callGemini(prompt, baseWords) {
      const res = await fetch('/api/gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          base: baseWords,
          prompt: prompt,
          count: Number(countInput.value)
        })
      });
      const data = await res.json();
      return data.words;
    }

    document.getElementById('modeToggle').addEventListener('click',()=>{
      mode = (mode === 'ai') ? 'word' : 'ai'; console.log('mode:', mode);
      modeToggle.textContent = mode==='ai'? 'AIãƒ¢ãƒ¼ãƒ‰':'å˜èªè¿½åŠ ãƒ¢ãƒ¼ãƒ‰';
    });

    genBtn.addEventListener('click', async () => {
      const prompt = promptInput.value;
      const bases = [...selectedNodes].map(n => n.textContent);
      if (bases.length === 0) {
        alert('å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      const results = await callGemini(prompt, bases);
      if (!results) return;

      let base = [...selectedNodes][0];
      let bx = parseInt(base.style.left); let by = parseInt(base.style.top);

      results.forEach((t,i)=>{
        createNode(t, bx + 120*(i+1), by + 60*(i%2));
      });
    });

    document.getElementById('text-mode-btn').addEventListener('click', () => {
      textMode = !textMode;
      if (textMode) alert('ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ');
    });

    board.addEventListener('click', e => {
      if (!textMode) return;
      const text = prompt('æ³¨é‡ˆå†…å®¹:');
      if (text) createNode(text, e.pageX, e.pageY);
      textMode = false;
    });
  </script>
</body>
</html>
