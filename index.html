<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¡ AIé€£æƒ³ãƒãƒƒãƒ— (å‹é”å°‚ç”¨)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f4f8; color: #333; }
        #container { max-width: 900px; margin: 0 auto; background-color: white; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); padding: 30px; }
        h1 { color: #007bff; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-bottom: 30px; }
        #input-area { display: flex; gap: 10px; margin-bottom: 25px; align-items: center; }
        #keyword-input { flex-grow: 1; padding: 12px; border: 2px solid #ccc; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        #keyword-input:focus { border-color: #007bff; outline: none; }
        #add-button, #generate-button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s, transform 0.1s; }
        #add-button { background-color: #28a745; color: white; }
        #add-button:hover { background-color: #218838; transform: translateY(-1px); }
        #generate-button { background-color: #ffc107; color: #333; }
        #generate-button:hover { background-color: #e0a800; transform: translateY(-1px); }
        
        #current-keywords { display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px; margin-bottom: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; background-color: #fafafa; }
        .keyword-tag { display: flex; align-items: center; padding: 8px 12px; background-color: #007bff; color: white; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .delete-btn { background: none; border: none; color: white; margin-left: 8px; font-weight: bold; cursor: pointer; opacity: 0.8; transition: opacity 0.3s; }
        .delete-btn:hover { opacity: 1; }

        #mindmap-output { padding: 15px 0; }
        .mindmap-node { display: inline-block; padding: 10px 18px; margin: 8px; background-color: #6c757d; color: white; border-radius: 25px; cursor: pointer; font-weight: 600; transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; user-select: none; }
        .mindmap-node:hover { transform: translateY(-2px); box-shadow: 0 3px 5px rgba(0,0,0,0.2); }
        .mindmap-node.selected { background-color: #dc3545; /* é¸æŠæ™‚ã®è‰² */ }

        .loading { text-align: center; color: #007bff; font-weight: bold; padding: 20px; }
        .error { color: #dc3545; padding: 10px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; }
    </style>
</head>
<body>

<div id="container">
    <h1>âœ¨ AIé€£æƒ³ãƒãƒƒãƒ—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ (ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—)</h1>
    
    <div id="input-area">
        <input type="text" id="keyword-input" placeholder="ã‚¢ã‚¤ãƒ‡ã‚¢ã®åŸºç‚¹ã¨ãªã‚‹å˜èªã‚’å…¥åŠ›...">
        <button id="add-button" onclick="addKeyword()">â• è¿½åŠ </button>
    </div>

    <h2>ç¾åœ¨ã®é€£æƒ³ã®ç¨®</h2>
    <div id="current-keywords">
        <p id="no-keywords-message" style="color: #6c757d;">å…¥åŠ›æ¬„ã«å˜èªã‚’å…¥ã‚Œã¦ã€Œè¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <button id="generate-button" onclick="generateMindMap()">âœ¨ é€£æƒ³ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿæˆ</button>
    <p style="font-size: small; color: #6c757d; margin-top: 5px;">* å˜èªã‚’è¤‡æ•°é¸æŠã—ã¦ç”Ÿæˆã™ã‚‹ã¨ã€ã‚¢ã‚¤ãƒ‡ã‚¢ãŒãƒŸãƒƒã‚¯ã‚¹ã•ã‚Œã¾ã™ã€‚</p>

    <h2>é€£æƒ³çµæœ</h2>
    <div id="mindmap-output">
        </div>
</div>

<script>
    const currentKeywordsDiv = document.getElementById('current-keywords');
    const outputDiv = document.getElementById('mindmap-output');
    const keywordInput = document.getElementById('keyword-input');
    
    // ------------------------------------------
    // 1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¿½åŠ ã¨å‰Šé™¤
    // ------------------------------------------

    function addKeyword() {
        const keyword = keywordInput.value.trim();
        if (!keyword) return;

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«
        const message = document.getElementById('no-keywords-message');
        if (message) message.style.display = 'none';

        const tag = document.createElement('div');
        tag.className = 'keyword-tag';
        tag.textContent = keyword;
        tag.onclick = toggleSelect; // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠãƒ»è§£é™¤

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'x';
        deleteBtn.onclick = (e) => {
            e.stopPropagation(); // è¦ªè¦ç´ ï¼ˆtagï¼‰ã®onclickã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ã
            tag.remove();
            checkKeywordCount();
        };

        tag.appendChild(deleteBtn);
        currentKeywordsDiv.appendChild(tag);
        keywordInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    }

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒ0ã«ãªã£ãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è¡¨ç¤º
    function checkKeywordCount() {
        if (currentKeywordsDiv.children.length === 0) {
            const message = document.createElement('p');
            message.id = 'no-keywords-message';
            message.style.color = '#6c757d';
            message.textContent = 'å…¥åŠ›æ¬„ã«å˜èªã‚’å…¥ã‚Œã¦ã€Œè¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            currentKeywordsDiv.appendChild(message);
        }
    }

    // ------------------------------------------
    // 2. ãƒãƒ¼ãƒ‰ã®é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰
    // ------------------------------------------

    function toggleSelect(event) {
        event.currentTarget.classList.toggle('selected');
    }

    // ------------------------------------------
    // 3. AIã«ã‚ˆã‚‹é€£æƒ³ç”Ÿæˆï¼ˆãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    // ------------------------------------------

    async function generateMindMap() {
        // ç¾åœ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã€ã¾ãŸã¯å…¨ã¦ï¼‰ã‚’å–å¾—
        const allNodes = Array.from(currentKeywordsDiv.querySelectorAll('.keyword-tag'));
        let selectedNodes = allNodes.filter(node => node.classList.contains('selected'));
        
        // é¸æŠãŒãªã‘ã‚Œã°ã€ç¾åœ¨ã®ã€Œé€£æƒ³ã®ç¨®ã€ã«å…¥ã£ã¦ã„ã‚‹å…¨ã¦ã‚’å¯¾è±¡ã¨ã™ã‚‹
        if (selectedNodes.length === 0) {
            selectedNodes = allNodes;
        }

        if (selectedNodes.length === 0) {
            alert("é€£æƒ³ã®ç¨®ã¨ãªã‚‹å˜èªã‚’æœ€ä½ä¸€ã¤è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const keywords = selectedNodes.map(node => node.textContent.replace('x', '').trim());
        
        // UIã®æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼‰
        outputDiv.innerHTML = `<div class="loading">âœ¨ ${keywords.join(' ã¨ ')} ã‹ã‚‰é€£æƒ³ä¸­...</div>`;

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰Gemini APIå‘¼ã³å‡ºã—ï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ã‚’æƒ³å®šï¼‰ â˜…â˜…â˜…
        
        // ğŸš¨ æ³¨æ„: ã“ã®fetchURLã¯ã€ã”è‡ªèº«ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
        // ğŸš¨ APIã‚­ãƒ¼ã‚’å®‰å…¨ã«æ‰±ã†ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        const fetchURL = '/api/generate-ideas'; 
        
        try {
            const response = await fetch(fetchURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keywords: keywords, count: 8 }) // ä¾‹ã¨ã—ã¦8å€‹ç”Ÿæˆ
            });

            if (!response.ok) {
                // ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°å´ã§ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒè¡Œã‚ã‚ŒãŸå ´åˆ
                throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            if (data.error) {
                // APIå´ã§å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆ
                 outputDiv.innerHTML = `<div class="error">é€£æƒ³å¤±æ•—: ${data.error}</div>`;
                 return;
            }

            // UIã‚’ã‚¯ãƒªã‚¢ã—ã¦çµæœã‚’æç”»
            outputDiv.innerHTML = '';
            renderNodes(data.relatedWords); 

        } catch (error) {
            console.error('Fetch Error:', error);
            outputDiv.innerHTML = `<div class="error">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°)ãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: ${error.message}</div>`;
        }
    }

    // ------------------------------------------
    // 4. çµæœã®æç”»
    // ------------------------------------------

    function renderNodes(words) {
        if (!words || words.length === 0) {
            outputDiv.innerHTML = '<p>AIã¯é–¢é€£ã™ã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>';
            return;
        }

        words.forEach(word => {
            const node = document.createElement('div');
            node.className = 'mindmap-node';
            node.textContent = word;
            
            // ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ç¾åœ¨ã®é€£æƒ³ã®ç¨®ã«è¿½åŠ ã•ã‚Œã‚‹
            node.onclick = () => {
                keywordInput.value = word;
                addKeyword();
                // è¿½åŠ å¾Œã¯é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                Array.from(outputDiv.querySelectorAll('.mindmap-node')).forEach(n => n.classList.remove('selected'));
            };
            
            outputDiv.appendChild(node);
        });
    }

</script>

</body>
</html>
